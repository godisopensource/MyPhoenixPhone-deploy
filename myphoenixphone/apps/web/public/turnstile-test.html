<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Turnstile test</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
      body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding: 2rem }
      .card { border: 1px solid #ddd; padding: 1rem; border-radius: 6px; max-width: 640px }
      pre { background:#f6f8fa;padding:8px;border-radius:6px;overflow:auto }
    </style>
  </head>
  <body>
    <h1>Turnstile test (localhost)</h1>
    <div class="card">
      <p>Widget using site key from your .env.local</p>
      <div id="turnstile-container"></div>
      <div id="status" style="margin-top:12px"></div>
      <h3>Console output</h3>
      <pre id="output">(no events yet)</pre>
    </div>

    <script>
      const siteKey = '0x4AAAAAAB789VyhRFeEWc6l';
      const out = document.getElementById('output');
      const status = document.getElementById('status');
      function log(...args) { out.textContent += '\n' + args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' '); console.log(...args); }

      function render() {
        if (typeof turnstile === 'undefined') {
          log('turnstile not defined yet');
          status.innerText = 'Script not loaded yet';
          return;
        }
        status.innerText = 'Rendering widget...';
        try {
          const id = turnstile.render(document.getElementById('turnstile-container'), {
            sitekey: siteKey,
            callback: (token) => { log('TOKEN', token); status.innerText = 'Token received'; },
            'error-callback': (err) => { log('ERROR-CALLBACK', err); status.innerText = 'Error: ' + JSON.stringify(err); },
          });
          log('rendered widget id', id);
        } catch (e) {
          log('render exception', e);
          status.innerText = 'Render exception: ' + e?.message;
        }
      }

      // Try to render once script loads
      if (typeof turnstile !== 'undefined') render();
      else {
        const s = document.querySelector('script[src*="turnstile"]');
        if (s) s.addEventListener('load', render);
        s?.addEventListener('error', () => { log('script load error'); status.innerText = 'Script load error'; });
      }
    </script>
  </body>
</html>
